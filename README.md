# IISCertImporter
A simple .NET script to automatically import and replace certificates in IIS

## Background
I needed a way to automatically deploy certificates generated by LetsEncrypt to a Windows/IIS environment.  For various reasons (bugs, logistics, etc.) the usual Powershell commands did not work, or were unavailable.  Consequently, I built this .NET script to handle the certificate import and replacement process.

## Prerequisites
- .NET Framework 4.8 or higher
- Windows Server with IIS.  Tested versions were Server 2008 R2 with IIS 7.5 (fully tested), or Server 2016 build 1607 with IIS 10 (partially tested)
- Encrypted .pfx file with both certificate and private key

## Compiling
1. Restore nuget packages
2. Compile!

## Installation
Simply copy all of the built files to a directory of your choice onto the server containing the IIS installation.  As an example, `C:\Utilities\CertImporter\`.

## Usage
The generic usage is as follows:
```
CertImporter.exe <Certificate Store Name> <.pfx file> <Certificate Friendly Name> <.pfx Password>
```
Some points of interest:
- Typically, the `Certificate Store Name` will reference either the "WebHosting" or "Personal" stores.  The "WebHosting" name is "WebHosting", but the "Personal" name is "MY", in all caps.  **In Server 2008, "MY" is required**, as it appears the "WebHosting" store is ignored.  In Server 2016 (and presumably others), "WebHosting" is recommended.
- For ease of use, I simply put the `.pfx file` in the same directory as the script.
- The `Certificate Friendly Name` is typically the domain of the site you are encrypting.  For example, "example.com", or "foo.example.com".  In the case of a wildcard certificate, use "*.example.com".
- Note that the `.pfx Password` is going to be an input to the command.  If the command is used in a script, use caution as to the permissions of the script file.  Additionally, use a unique password for each .pfx file.

A complete command for any subdomained site at example.com (foo.example.com, bar.example.com, baz.bar.example.com, etc.) would be
```
CertImporter.exe MY example.com.pfx "*.example.com" MyPfxPassword
```

### First Run
Upon first run, this script will not affect any sites.  Instead, it will import the provided certificate and key into the specified certificate store, write two files to the local directory (the "Certificate Hash String", aka the thumbprint, and the "Certificate Hash", which appears to be a binary hash), and then exit.  These two files represent the previous run's certificate, and are used to track what certificate needs to be replaced.

### Subsquent Runs
After the first run has completed, any subsquent run may or may not affect sites.  A subsquent run will import the new certificate, read the previous run's Hash and Hash String files, and then search the Certificate Store for the previous run's certificate (by matching the Hash String, aka thumbprint).

The script will then search through all bindings of all sites for any binding that uses the previous run's certificate (this time, by matching the Hash, not the Hash String).  The binding is updated to use the *new* Hash/Hash String.  Finally, the old certificate is removed from the Certificate Store, and the current run's Hash/Hash String are written to the local directory.

## Using Certs Within This Tool
To take advantage of this tool, simply run it once to import the certificate and generate the Hash/Hash String files.  Then, create an https binding like you normally would, and use the certificate you just imported.  When a subsquent run occurs and the certificate is replaced, the binding will automatically use the new certificate.
